---

- hosts: all
  vars_files:
    - cis_vars.yml

  tasks:
# PRELIM WORKSPACE SETUP (NEEDED FOR CLEANUP)
  - name: check for workspace
    stat:
      path: "{{ WORKSPACE_PATH }}"
    register: sym

  - debug: { msg: "{{ sym }}" }

  - name: create workspace dir if not exist
    file:
      path: "{{ WORKSPACE_PATH }}"
      state: directory
    when: sym.stat.exists == false
    become: yes

# AUDIT
  - name: Check for Enabled Services
    command: "systemctl is-enabled {{item}}"
    with_items: "{{ DEFAULT_ENABLED_SERVICES }}"
    ignore_errors: yes
    register: DEFAULT_ENABLED_SERVICES_STATE

# CREATE/UPDATE
#   INSTALL PACKAGES FROM CIS_VAR INSTALL LIST
  - name: Install Basic Packages
    action: >
      {{ ansible_pkg_mgr }} name={{ item }} state=present update_cache=yes
    with_items: "{{ INSTALL_DEFAULT_PKGS }}"
    become: yes

#   REMOVE PACKAGES FROM CIS_VAR REMOVE LIST
  - name: Remove Problematic Packages
    action: >
      {{ ansible_pkg_mgr }} name={{ item }} state=absent update_cache=yes
    with_items: "{{ REMOVE_DEFAULT_PKGS }}"
    become: yes
    ignore_errors: yes

  - name: Generate CIS.conf module blacklist
    template:
      backup: yes
      src: templates/cis.j2
      dest: /etc/modprobe.d/cis.conf
    become: yes

  - name: Generate sysctl.conf defaults
    template:
      backup: yes
      src: templates/sysctl.conf.j2
      dest: /etc/sysctl.conf
    become: yes

  - name: Reload sysctl from config
    command: "sysctl --system"

  - name: Enable default CIS systemd services
    service:
      name: "{{ item }}"
      state: restarted
    with_items: "{{DEFAULT_ENABLED_SERVICES}}"
    become: yes
    ignore_errors: yes

  - name: Disable default CIS systemd services
    service:
      name: "{{ item }}"
      state: stopped
    with_items: "{{DEFAULT_DISABLED_SERVICES}}"
    become: yes
    ignore_errors: yes

# CLEANUP TEMPLATE BACKUPS

  - name: Find Ansible Backups for Cleanup
    find:
      paths: '/etc'
      patterns: "{{ TEMPLATE_FILES }}"
      recurse: yes
    register: find_results

  - debug: "{ msg: {{ find_results['files'] }} }"
  - name: Move Template Backups from sensitive folders to
    command: "mv {{item['path'] }} {{ WORKSPACE_PATH }}"
    with_items: "{{ find_results['files'] }}"
    become: yes
    when: find_results['files'] is defined
